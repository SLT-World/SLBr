<html style="background-repeat: no-repeat;background-size: cover;background-position: center;">
    <head>
        <meta charset="utf-8"/>
        <title>New Tab</title>
        <link rel="stylesheet" type="text/css" href="./style.css"/>
    </head>
    <body>
        <style>
html {
    background-repeat: no-repeat;
    background-size: auto;
}

html.background-image::before {
    content: "";
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    background: linear-gradient(to bottom, rgba(0, 0, 0, 0.5) 0%, rgba(0, 0, 0, 0) 25%, rgba(0, 0, 0, 0) 75%, rgba(0, 0, 0, 0.5) 100%);
    pointer-events: none;
}

html.background-image .SearchInput {
    box-shadow: 0 2px 6px 0 #20212451;
}

html.background-image div.nav > a > p {
    text-shadow: 0 0 10px rgba(0, 0, 0, 0.75);
}

div.nav {
    padding-left: 0px;
    background-color: transparent;
    text-align: center;
    margin-top: 15px;
    list-style-position: inside;
    font-size: small;
    width: 75vw;
    max-width: 750px;
    display: grid;
    grid-template-columns: repeat(auto-fit, 70px);
    gap: 10px;
    align-items: center;
    justify-content: center;
}

div.nav > a {
    display: inline-flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 5px;
    width: 70px;
    height: 70px;
}

div.nav > a > div {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background-color: color-mix(in srgb, var(--secondary), transparent);
    backdrop-filter: blur(5px);
    border-radius: 10px;
    transition: background-color 0.25s ease;
}

div.nav > a:hover > div {
    background-color: color-mix(in srgb, var(--tertiary), transparent);
}

div.nav > a > div > img {
    user-select: none;
    border-radius: 5px;
}

div.nav > a > p {
    color: color-mix(in srgb, transparent, var(--font) 80%);
    font-size: small;
    width: 100%;
    overflow: clip;
    text-overflow: ellipsis;
    text-wrap-mode: nowrap;
}
        </style>
        <div class="Center NewTabSearchContainer">
            <div>
                <div class="Center" style="padding-bottom: 25px;">
                    <img class="Center SLBrIcon" style="user-select: none;" src="./SLBr.ico" width="100" height="100" />
                </div>
                <div class="SearchInput">
                    <span class="font-icon"></span>
                    <input type="text" id="SearchField" autocomplete="off" placeholder="Search or enter address" />
                </div>
                <div class="Center">
                    <div class="nav">
                        <a href="https://www.youtube.com" class="Center">
                            <div>
                                <img src="https://www.youtube.com/favicon.ico" alt="YouTube" width="60%" height="60%" />
                            </div>
                            <p>YouTube</p>
                        </a>
                        <a href="https://www.outlook.com" class="Center">
                            <div>
                                <img src="https://outlook.live.com/mail/favicon.ico" alt="Outlook" width="60%" height="60%" />
                            </div>
                            <p>Outlook</p>
                        </a>
                        <a href="https://www.gmail.com" class="Center">
                            <div>
                                <img src="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico" alt="Gmail" width="60%" height="60%" />
                            </div>
                            <p>Gmail</p>
                        </a>
                        <a href="https://www.stackoverflow.com" class="Center">
                            <div>
                                <img src="https://cdn.sstatic.net/Sites/stackoverflow/Img/favicon.ico" alt="Stack Overflow" width="60%" height="60%" />
                            </div>
                            <p>Stack Overflow</p>
                        </a>
                        <a href="https://www.facebook.com" class="Center">
                            <div>
                                <img src="https://www.facebook.com/favicon.ico" alt="Facebook" width="60%" height="60%" />
                            </div>
                            <p>Facebook</p>
                        </a>
                        <a href="https://www.twitter.com" class="Center">
                            <div>
                                <img src="https://abs.twimg.com/favicons/twitter.3.ico" alt="Twitter" width="60%" height="60%" />
                            </div>
                            <p>Twitter</p>
                        </a>
                        <a href="https://www.reddit.com" class="Center">
                            <div>
                                <img src="https://www.redditstatic.com/shreddit/assets/favicon/64x64.png" alt="Reddit" width="60%" height="60%" />
                            </div>
                            <p>Reddit</p>
                        </a>
                        <a href="https://www.amazon.com" class="Center">
                            <div>
                                <img src="https://www.amazon.com/favicon.ico" alt="Amazon" width="60%" height="60%" />
                            </div>
                            <p>Amazon</p>
                        </a>
                        <a href="https://www.wikipedia.org" class="Center">
                            <div>
                                <img src="https://www.wikipedia.org/static/favicon/wikipedia.ico" alt="Wikipedia" width="60%" height="60%" />
                            </div>
                            <p>Wikipedia</p>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <h2 style="position: absolute; top: 25px; left: 25px; height: 35px; display: flex; align-items: center; font-weight: 500;" id="clock"></h2>
        <button style="border:none;position: absolute;top: 25px;right: 25px;background: transparent;" class="icon" onclick="toggleDialog('customize')">
            <span class="icon_button"></span>
        </button>
        <p id="background-description" style="position: absolute; bottom: 25px; left: 25px; color: color-mix(in srgb, transparent, white); "></p>
        <div class="dialog" id="dialog_customize">
            <div>
                <span class="icon_button"></span>
                <h1>Customize</h1>
                <button style="margin-left: auto;border:none;" class="icon" onclick="toggleDialog('customize')">
                    <span class="icon_button"></span>
                </button>
            </div>
            <div class="tab-control" style="--tabstrip-width: 150px;">
                <div>
                    <button class="tab active" id="tab_background" onclick="openTab(event)" style="--indicator: mediumslateblue;"><span class="icon_button"></span>Background</button>
                    <button class="tab" id="tab_clock" onclick="openTab(event)" style="--indicator: gold;"><span class="icon_button"></span>Clock</button>
                </div>
                <div>
                    <div id="tabcontent_background" class="tabcontent active">
                        <div class="groupbox">
                            <div class="field">
                                <p>Background</p>
                                <select class="input" data-setting="background">
                                    <option value="0">Custom</option>
                                    <option value="1">Bing</option>
                                    <option value="2">Picsum</option>
                                    <option value="3">NASA</option>
                                    <option value="4">Wikipedia</option>
                                    <option value="5">Wikimedia</option>
                                </select>
                            </div>
                            <hr id="backgroundSeparator"/>
                            <div class="field">
                                <p>Bing</p>
                                <select class="input" data-setting="bingBackground">
                                    <option value="0">Image of the day</option>
                                    <option value="1">Random</option>
                                </select>
                            </div>
                            <div class="field">
                                <p>Custom Path</p>
                                <input type="text" class="input" autocomplete="off" data-setting="customBackground" />
                            </div>
                        </div>
                    </div>
                    <div id="tabcontent_clock" class="tabcontent">
                        <div class="groupbox">
                            <div class="field">
                                <p>Clock</p>
                                <label class="switch input" data-setting="clock">
                                    <input type="checkbox">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <hr />
                            <div class="field">
                                <p>Format</p>
                                <select class="input" data-setting="clockFormat">
                                    <option value="0">12-hour</option>
                                    <option value="1">24-hour</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script type="text/javascript">
    const defaults = {
        background: "0",
        bingBackground: "0",
        customBackground: "",
        clock: "false",
        clockFormat: "0",
        weather: "false",
    };
    for (const key in defaults) {
        if (localStorage.getItem(key) === null) localStorage.setItem(key, defaults[key]);
    }
    let inputs = document.querySelectorAll("[data-setting]");
    inputs.forEach(w => {
        const key = w.dataset.setting;
        const e = w.tagName === "LABEL" ? w.querySelector("input") : w;

        if (!e) return;
        let stored = localStorage.getItem(key);

        if (stored !== null) {
            if (e.tagName === "SELECT") e.value = stored;
            else if (e.type === "checkbox") e.checked = stored === "true";
            else e.value = stored;
        }
        const evt = e.type === "checkbox" || e.tagName === "SELECT" ? "change" : "input";
        e.addEventListener(evt, () => {
            let value;
            if (e.type === "checkbox") value = e.checked;
            else value = e.value;
            localStorage.setItem(key, value);
            setNewTabBackground();
        });
    });
    const backgroundSeparator = document.getElementById("backgroundSeparator");
    const searchField = document.getElementById("SearchField");
    function updateBackgroundSettingsUI() {
        const mode = parseInt(localStorage.getItem("background") || "0");
        const bingGroup = document.querySelector('[data-setting="bingBackground"]').closest(".field");
        const customPath = document.querySelector('[data-setting="customBackground"]').closest(".field");
        bingGroup.style.display = mode === 1 ? "" : "none";
        customPath.style.display = mode === 0 ? "" : "none";
        backgroundSeparator.style.display = mode != 1 && mode != 0 ? "none" : "";
    }
    document.addEventListener("change", e => {
        if (!e.target.closest("[data-setting]")) return;
        updateBackgroundSettingsUI();
        applyClockSetting();
    });
    updateBackgroundSettingsUI();
    document.addEventListener("DOMContentLoaded", setNewTabBackground);
    searchField.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') internal.search(searchField.value);
    });
    function removeHTML(str) { return str.replace(/<[^>]*>?/gm, ''); }
    const backgroundDescription = document.getElementById('background-description');
    function onCorsResult(value) {
        try {
            let mode = parseInt(localStorage.getItem("background") || "0");
            if (mode === 1) {
                let json = JSON.parse(value);
                let url = json.images[0].url;
                if (url) setBackground("http://www.bing.com/" + url);
                let desc = `<span style="color:color-mix(in srgb, transparent, white 75%);">${removeHTML(json.images[0].title)}</span> - ${removeHTML(json.images[0]?.copyright || 'Bing')}`;
                backgroundDescription.innerHTML = desc;
            }
            else if (mode === 3) {
                let json = JSON.parse(value);
                let url = navigator.connection.saveData ? json.url : json.hdurl;
                if (url) setBackground(url);
                let desc = `<span style="color:color-mix(in srgb, transparent, white 75%);">${removeHTML(json.title)}</span> - ${removeHTML(json.copyright || 'NASA')}`;
                backgroundDescription.innerHTML = desc;
                backgroundDescription.title = json.explanation;
            }
            else if (mode === 4 || mode === 5) {
                let json = JSON.parse(value);
                let pages = json.query?.pages;
                for (const page of Object.values(pages)) {
                    let imginfo = page?.imageinfo?.[0];
                    if (imginfo) {
                        let url = imginfo.url;
                        if (url) setBackground(url);
                        let desc = `<span style="color:color-mix(in srgb, transparent, white 75%);">${removeHTML(page?.title || 'Picture of the Day').replace(/^File:|(\.[a-z0-9]+)$/gi, "")}</span> - ${removeHTML((imginfo?.extmetadata?.Artist?.value || 'Wikimedia Commons'))}`;
                        backgroundDescription.innerHTML = desc;
                        break;
                    }
                }
            }
            else if (mode === 0 && value.startsWith("data:image")) setBackground(value);
        } catch (e) {
            console.error(`Background parse failed: ${e}`);
            setBackground("");
        }
    }
    async function setNewTabBackground() {
        backgroundDescription.innerHTML = "";
        backgroundDescription.title = "";
        let mode = parseInt(localStorage.getItem("background") || "0");
        switch (mode) {
            case 0: {
                let custom = localStorage.getItem("customBackground") || "";
                if (!custom) {
                    setBackground("");
                    return;
                }
                if (custom.startsWith("http://") || custom.startsWith("https://") || custom.startsWith("data:")) setBackground(custom);
                else engine.postMessage({ type: "__internal__", function: "cors", url: custom });
                return;
            }
            case 1: {
                let bingMode = parseInt(localStorage.getItem("bingBackground") || "0");
                //WARNING: mkt query necessary for title.
                if (bingMode === 0) engine.postMessage({ type: "__internal__", function: "cors", url: "https://www.bing.com/hpimagearchive.aspx?format=js&idx=0&n=1&mkt=en-US" });
                else setBackground("http://bingw.jasonzeng.dev/?index=random");
                return;
            }
            case 2: {
                setBackground("http://picsum.photos/1920/1080?random");
                return;
            }
            case 3: {
                const response = await fetch("https://api.nasa.gov/planetary/apod?api_key=DEMO_KEY");
                onCorsResult(await response.text());
                return;
            }
            case 4: {
                const response = await fetch(`https://en.wikipedia.org/w/api.php?action=query&generator=images&titles=Template:POTD/${new Date().toISOString().slice(0, 10)}&prop=imageinfo&iiprop=extmetadata|url&format=json&origin=*`);
                onCorsResult(await response.text());
                return;
            }
            case 5: {
                const response = await fetch(`https://commons.wikimedia.org/w/api.php?action=query&generator=images&titles=Template:Potd/${new Date().toISOString().slice(0, 10)}&prop=imageinfo&iiprop=extmetadata|url&format=json&origin=*`);
                onCorsResult(await response.text());
                return;
            }
        }
    }
    function setBackground(url) {
        if (!url) {
            document.documentElement.style.backgroundImage = "";
            document.documentElement.classList.remove("background-image");
            return;
        }
        document.documentElement.style.backgroundImage = `url('${url}')`;
        document.documentElement.classList.add("background-image");
    }

    function openTab(event) {
        var tabcontent = document.getElementsByClassName("tabcontent");
        for (var i = 0; i < tabcontent.length; i++) {
            tabcontent[i].classList.remove("active");
        }
        var tabs = document.getElementsByClassName("tab");
        for (var i = 0; i < tabs.length; i++) {
            tabs[i].classList.remove("active");
        }
        document.getElementById(`tabcontent_${event.currentTarget.id.split('_')[1]}`).classList.add("active");
        event.currentTarget.classList.add("active");
    }

    function toggleDialog(name) {
        var id = `dialog_${name}`;
        var dialogs = document.getElementsByClassName("dialog");
        for (var i = 0; i < dialogs.length; i++) {
            if (dialogs[i].id == id)
                dialogs[i].classList.toggle("active");
            else if (dialogs[i].classList.contains("active"))
                dialogs[i].classList.remove("active");
        }
    }
    const clock = document.getElementById("clock");
    function updateClock() {
        const now = new Date();
        let hours = now.getHours();
        if (parseInt(localStorage.getItem("clockFormat") || "0") == 0)
            hours = hours % 12 || 12;
        let minutes = now.getMinutes();
        minutes = minutes < 10 ? '0' + minutes : minutes;
        clock.textContent = hours + ':' + minutes;
    }
    let clockInterval;
    function applyClockSetting() {
        const enabled = localStorage.getItem("clock") === "true";
        clock.style.display = enabled ? "" : "none";
        if (enabled) {
            updateClock();
            if (!clockInterval)
                clockInterval = setInterval(updateClock, 60000);
        }
        else if (clockInterval) {
            clearInterval(clockInterval);
            clockInterval = null;
        }
    }
    applyClockSetting();
    document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
            if (clockInterval) {
                clearInterval(clockInterval);
                clockInterval = null;
            }
        } else applyClockSetting();
    });
        </script>
    </body>
</html>